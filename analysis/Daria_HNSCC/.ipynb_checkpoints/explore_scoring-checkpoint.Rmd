---
title: "explore_scoring"
output: html_document
---

```{r}
#------------------------------------------------------------------------------------------------------------------------------------------------#
# applying the rank metric 

# The purpose of the rank metric is to rank the junction scores against thte conglomerate reference transcript score distribution and give a rank score from 0-1 that tells how close the rank 
# is to being ranked such that all scores are ranked the highest possible wrt to the reference distribution. All scores above or below reference range are conglomerated to the highest and lowest 
# rank respectfully. 

#loading the modified transcript data
filenames_ref<-read.csv("/media/theron/My_Passport/data/references_full/mhc_I_scores/scores.txt",  header = FALSE)

#loading reference data
load("/media/theron/My_Passport/data/references_full/kmers_ref_tx.Rdata") # incldues trans_orf which is transcript referenece
filenames_mod<-read.csv("/media/theron/My_Passport/data/mhc_I_dat/scores.txt", header = FALSE)

start_time<-Sys.time()
num_file<-nrow(filenames_ref)
scores_ref<-vector(mode = "list", length = num_file)
scores_ref_av<-vapply(seq_len(num_file),function(x){
  ref_scores<-readRDS(sprintf("%s.scores.rds",filenames_ref[x,]))
  mean(unlist(ref_scores))
},numeric(1))


ref_scores_av<-readRDS(sprintf("%s.scores.rds",filenames_ref[1,]))
# plot(hist(unlist(ref_scores)),cex.axis=1.4,cex.lab=1.4,cex.main=1.5,main="",xlab="Affinity Score")
lengths<-vapply(seq_len(length(ref_scores_av)),function(x){
  length(ref_scores_av[[x]])
},numeric(1))
av_lengths <- ceiling(mean(lengths))

sorted<-sort(scores_ref_av,index.return=TRUE)
#median of sorted is closest to filename[74,]
# "/media/theron/My_Passport/data/references_full/mhc_I_scores/HLA-A02-06.txt"
# ref_scores<-readRDS(sprintf("%s.scores.rds",filenames_ref[sorted$ix[74],]))
ref_scores<-readRDS(sprintf("%s.scores.rds","/media/theron/My_Passport/data/references_full/mhc_I_scores/HLA-A02-06.txt"))
ref_all<-unlist(ref_scores)

rank_sum<-function(scores_mod,scores_ref){
  # This function ranks the modified scores wrt the reference transcript distribution
  # The output is 0-1 where 0 says that the modified transcript is the lowest score relative to reference and 1 is the highest. 
  out<-0
  counts_mod<-c()
  counts_ref<-c()
  num_mod<-length(scores_mod)
  mod_range<-range(scores_mod)
  num_ref<-length(scores_ref)
  ref_range<-range(scores_ref)
  minimum<-floor(ref_range[1])
  maximum<-ceiling(ref_range[2])
  counts_mod<-vapply((minimum-1):(maximum),
  function(x){
    if (x == minimum-1){
      length(which(scores_mod < x+1))*(x-minimum+1+1)
    } else if(x == maximum){
      length(which(scores_mod >= x))*((maximum+1)-minimum+1)
    } else {
      length(which(scores_mod >= x & scores_mod < x+1))*(x+1-minimum+1)
    }
  }, numeric(1))
  max_rank<-max(range(counts_mod))
  out<-sum(counts_mod[counts_mod>0])/(length(scores_mod)*max_rank) #the ranking step
  return(1-out)
}

```

This method is looking at the references while using the entire range of non-binding ic50 scores
```{r}
library(ggplot2)

sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-ref_all[ref_all>500]

rank_sb_wb<-data.frame(vector(mode="numeric",length = 101))
rank_sb_nb<-data.frame(vector(mode="numeric",length = 101))
rank_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq_len(3)){
  print(i)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,av_lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,av_lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,av_lengths-percent))
   }
  })
  
  rank_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    rank_sum(x,ref_all)
  },numeric(1))
  rank_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    rank_sum(x,ref_all)
  },numeric(1))
  rank_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    rank_sum(x,ref_all)
  },numeric(1))
}
rank_sb_wb$mean<-apply(rank_sb_wb[,1:3],MARGIN=1,FUN=mean)
rank_sb_wb$std<-apply(rank_sb_wb[,1:3],MARGIN=1,FUN=sd)
rank_sb_nb$mean<-apply(rank_sb_nb[,1:3],MARGIN=1,FUN=mean)
rank_sb_nb$std<-apply(rank_sb_nb[,1:3],MARGIN=1,FUN=sd)
rank_wb_nb$mean<-apply(rank_wb_nb[,1:3],MARGIN=1,FUN=mean)
rank_wb_nb$std<-apply(rank_wb_nb[,1:3],MARGIN=1,FUN=sd)

colnames(rank_sb_wb)<-c(1:3,"mean","std")
colnames(rank_sb_nb)<-c(1:3,"mean","std")
colnames(rank_wb_nb)<-c(1:3,"mean","std")


ggplot(rank_sb_wb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Weak Binder Filler",
        x ="Percent Strong Binders", y = "Rank Score") + ylim(0,1)
ggplot(rank_sb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Non-Binder Filler",
        x ="Percent Strong Binders", y = "Rank Score") + ylim(0,1)
ggplot(rank_wb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Weak Binders with Non-Binder Filler",
        x ="Percent Weak Binders", y = "Rank Score") + ylim(0,1)
```
Basically,the larger the range of non-binder values, the more variability at the low percentage of strong binders. 


This method is looking at the reference while using a limited (500-> 2000) range of non-binding ic50 scores
```{r}
library(ggplot2)

sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-ref_all[ref_all>500 & ref_all<=2000]

rank_sb_wb<-data.frame(vector(mode="numeric",length = 101))
rank_sb_nb<-data.frame(vector(mode="numeric",length = 101))
rank_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq_len(3)){
  print(i)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,av_lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,av_lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,av_lengths-percent))
   }
  })
  
  rank_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    rank_sum(x,ref_all[ref_all <= 2000])
  },numeric(1))
  rank_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    rank_sum(x,ref_all[ref_all <= 2000])
  },numeric(1))
  rank_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    rank_sum(x,ref_all[ref_all <= 2000])
  },numeric(1))
}
rank_sb_wb$mean<-apply(rank_sb_wb[,1:3],MARGIN=1,FUN=mean)
rank_sb_wb$std<-apply(rank_sb_wb[,1:3],MARGIN=1,FUN=sd)
rank_sb_nb$mean<-apply(rank_sb_nb[,1:3],MARGIN=1,FUN=mean)
rank_sb_nb$std<-apply(rank_sb_nb[,1:3],MARGIN=1,FUN=sd)
rank_wb_nb$mean<-apply(rank_wb_nb[,1:3],MARGIN=1,FUN=mean)
rank_wb_nb$std<-apply(rank_wb_nb[,1:3],MARGIN=1,FUN=sd)

colnames(rank_sb_wb)<-c(1:3,"mean","std")
colnames(rank_sb_nb)<-c(1:3,"mean","std")
colnames(rank_wb_nb)<-c(1:3,"mean","std")


ggplot(rank_sb_wb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Weak Binder Filler",
        x ="Percent Strong Binders", y = "Rank Score") + ylim(0,1)
ggplot(rank_sb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Non-Binder Filler",
        x ="Percent Strong Binders", y = "Rank Score") + ylim(0,1)
ggplot(rank_wb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Weak Binders with Non-Binder Filler",
        x ="Percent Weak Binders", y = "Rank Score") + ylim(0,1)
```
This method is looking at the reference while using a limited (500-> 1000) range of non-binding ic50 scores

```{r}
sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-ref_all[ref_all>500 & ref_all<=1000]

library(ggplot2)

rank_sb_wb<-data.frame(vector(mode="numeric",length = 101))
rank_sb_nb<-data.frame(vector(mode="numeric",length = 101))
rank_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq_len(3)){
  print(i)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,av_lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,av_lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,av_lengths-percent))
   }
  })
  
  rank_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    rank_sum(x,ref_all[ref_all <= 1000])
  },numeric(1))
  rank_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    rank_sum(x,ref_all[ref_all <= 1000])
  },numeric(1))
  rank_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    rank_sum(x,ref_all[ref_all <= 1000])
  },numeric(1))
}
rank_sb_wb$mean<-apply(rank_sb_wb[,1:3],MARGIN=1,FUN=mean)
rank_sb_wb$std<-apply(rank_sb_wb[,1:3],MARGIN=1,FUN=sd)
rank_sb_nb$mean<-apply(rank_sb_nb[,1:3],MARGIN=1,FUN=mean)
rank_sb_nb$std<-apply(rank_sb_nb[,1:3],MARGIN=1,FUN=sd)
rank_wb_nb$mean<-apply(rank_wb_nb[,1:3],MARGIN=1,FUN=mean)
rank_wb_nb$std<-apply(rank_wb_nb[,1:3],MARGIN=1,FUN=sd)

colnames(rank_sb_wb)<-c(1:3,"mean","std")
colnames(rank_sb_nb)<-c(1:3,"mean","std")
colnames(rank_wb_nb)<-c(1:3,"mean","std")


ggplot(rank_sb_wb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Weak Binder Filler",
        x ="Percent Strong Binders", y = "Rank Score") + ylim(0,1)
ggplot(rank_sb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Non-Binder Filler",
        x ="Percent Strong Binders", y = "Rank Score") + ylim(0,1)
ggplot(rank_wb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Weak Binders with Non-Binder Filler",
        x ="Percent Weak Binders", y = "Rank Score") + ylim(0,1)

```
Static non-binder value
```{r}
library(ggplot2)

sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-rep(501,av_lengths)
# nb<-ref_all[ref_all>500 & ref_all<=1000]
rank_sb_wb<-data.frame(vector(mode="numeric",length = 101))
rank_sb_nb<-data.frame(vector(mode="numeric",length = 101))
rank_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq_len(10)){
  print(i)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,av_lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,av_lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,av_lengths-percent))
   }
  })
  
  rank_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    rank_sum(x,ref_all[ref_all <= 501])
  },numeric(1))
  rank_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    rank_sum(x,ref_all[ref_all <= 501])
  },numeric(1))
  rank_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    rank_sum(x,ref_all[ref_all <= 501])
  },numeric(1))
}
rank_sb_wb$mean<-apply(rank_sb_wb[,1:3],MARGIN=1,FUN=mean)
rank_sb_wb$std<-apply(rank_sb_wb[,1:3],MARGIN=1,FUN=sd)
rank_sb_nb$mean<-apply(rank_sb_nb[,1:3],MARGIN=1,FUN=mean)
rank_sb_nb$std<-apply(rank_sb_nb[,1:3],MARGIN=1,FUN=sd)
rank_wb_nb$mean<-apply(rank_wb_nb[,1:3],MARGIN=1,FUN=mean)
rank_wb_nb$std<-apply(rank_wb_nb[,1:3],MARGIN=1,FUN=sd)

colnames(rank_sb_wb)<-c(1:3,"mean","std")
colnames(rank_sb_nb)<-c(1:3,"mean","std")
colnames(rank_wb_nb)<-c(1:3,"mean","std")


ggplot(rank_sb_wb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Weak Binder Filler",
        x ="Percent Strong Binders", y = "Rank Score") + ylim(0,1)
ggplot(rank_sb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Non-Binder Filler",
        x ="Percent Strong Binders", y = "Rank Score") + ylim(0,1)
ggplot(rank_wb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Weak Binders with Non-Binder Filler",
        x ="Percent Weak Binders", y = "Rank Score") + ylim(0,1)
# plot(rank_sb_wb,xlab="% Strong Binders",ylab="Rank Score",main="Strong and Weak Binders")
# plot(rank_sb_nb,xlab="% Strong Binders",ylab="Rank Score",main="Strong and No Binders")
# plot(rank_wb_nb,xlab="% Weak Binders",ylab="Rank Score",main="Weak and No Binders")
```

Playing with rank_sum() function because it appears to set 100% no binders to 50% rank min when should be zero
```{r}
rank_sum<-function(scores_mod,scores_ref){
  # This function ranks the modified scores wrt the reference transcript distribution
  # The output is 0-1 where 0 says that the modified transcript is the lowest score relative to reference and 1 is the highest. 
  out<-0
  counts_mod<-c()
  counts_ref<-c()
  num_mod<-length(scores_mod)
  mod_range<-range(scores_mod)
  num_ref<-length(scores_ref)
  ref_range<-range(scores_ref)
  minimum<-floor(ref_range[1])
  maximum<-ceiling(ref_range[2])
  counts_mod<-vapply(seq(0,maximum),
  function(x){
    if (x < 1){
      length(which(scores_mod < 1))*x
    } else if(x >= maximum){
      length(which(scores_mod >= x))*x
    } else {
      length(which(scores_mod >= x & scores_mod < x+1))*x
    }
  }, numeric(1))
  max_rank<-length(counts_mod)
  out<-sum(counts_mod[counts_mod>0])/(length(scores_mod)*(max_rank-1)) #the ranking step
  return(1-out)
}

scores_mod<-c()
scores_mod[1:av_lengths]<-0
scores_ref<-ref_all[ref_all<=501]
vals<-rank_sum(scores_mod,scores_ref)
```

Playing with other methods for determining where one distribution ranks in another reference
```{r}
library(ggplot2)

sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-ref_all[ref_all>500]

perc_sb_wb<-data.frame(vector(mode="numeric",length = 101))
perc_sb_nb<-data.frame(vector(mode="numeric",length = 101))
perc_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq_len(3)){
  print(i)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,av_lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,av_lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,av_lengths-percent))
   }
  })
  sorted_ref_all<-sort(ref_all)
  len_ref_all<-length(ref_all)
  perc_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  print("first done")
  perc_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  print("second done")
  perc_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
}
perc_sb_wb$mean<-apply(perc_sb_wb[,1:3],MARGIN=1,FUN=mean)
perc_sb_wb$std<-apply(perc_sb_wb[,1:3],MARGIN=1,FUN=sd)
perc_sb_nb$mean<-apply(perc_sb_nb[,1:3],MARGIN=1,FUN=mean)
perc_sb_nb$std<-apply(perc_sb_nb[,1:3],MARGIN=1,FUN=sd)
perc_wb_nb$mean<-apply(perc_wb_nb[,1:3],MARGIN=1,FUN=mean)
perc_wb_nb$std<-apply(perc_wb_nb[,1:3],MARGIN=1,FUN=sd)

colnames(perc_sb_wb)<-c(1:3,"mean","std")
colnames(perc_sb_nb)<-c(1:3,"mean","std")
colnames(perc_wb_nb)<-c(1:3,"mean","std")


ggplot(perc_sb_wb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Weak Binder Filler",
        x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
ggplot(perc_sb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Non-Binder Filler",
        x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
ggplot(perc_wb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Weak Binders with Non-Binder Filler",
        x ="Percent Weak Binders", y = "Average Percentile") + ylim(0,1)

```
Playing with other methods for determining where one distribution ranks in another reference
```{r}
library(ggplot2)

sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-ref_all[ref_all>500 & ref_all <= 2000]

perc_sb_wb<-data.frame(vector(mode="numeric",length = 101))
perc_sb_nb<-data.frame(vector(mode="numeric",length = 101))
perc_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq_len(3)){
  print(i)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,av_lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,av_lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,av_lengths-percent))
   }
  })
  sorted_ref_all<-sort(ref_all[ref_all <= 2000])
  len_ref_all<-length(sorted_ref_all)
  perc_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  print("first done")
  perc_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  print("second done")
  perc_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
}
perc_sb_wb$mean<-apply(perc_sb_wb[,1:3],MARGIN=1,FUN=mean)
perc_sb_wb$std<-apply(perc_sb_wb[,1:3],MARGIN=1,FUN=sd)
perc_sb_nb$mean<-apply(perc_sb_nb[,1:3],MARGIN=1,FUN=mean)
perc_sb_nb$std<-apply(perc_sb_nb[,1:3],MARGIN=1,FUN=sd)
perc_wb_nb$mean<-apply(perc_wb_nb[,1:3],MARGIN=1,FUN=mean)
perc_wb_nb$std<-apply(perc_wb_nb[,1:3],MARGIN=1,FUN=sd)

colnames(perc_sb_wb)<-c(1:3,"mean","std")
colnames(perc_sb_nb)<-c(1:3,"mean","std")
colnames(perc_wb_nb)<-c(1:3,"mean","std")


ggplot(perc_sb_wb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Weak Binder Filler",
        x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
ggplot(perc_sb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Non-Binder Filler",
        x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
ggplot(perc_wb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Weak Binders with Non-Binder Filler",
        x ="Percent Weak Binders", y = "Average Percentile") + ylim(0,1)

```
Playing with other methods for determining where one distribution ranks in another reference
```{r}
library(ggplot2)

sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-ref_all[ref_all>500 & ref_all <= 1000]

perc_sb_wb<-data.frame(vector(mode="numeric",length = 101))
perc_sb_nb<-data.frame(vector(mode="numeric",length = 101))
perc_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq_len(3)){
  print(i)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,av_lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,av_lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,av_lengths-percent))
   }
  })
  sorted_ref_all<-sort(ref_all[ref_all <= 1000])
  len_ref_all<-length(sorted_ref_all)
  perc_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  print("first done")
  perc_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  print("second done")
  perc_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
}
perc_sb_wb$mean<-apply(perc_sb_wb[,1:3],MARGIN=1,FUN=mean)
perc_sb_wb$std<-apply(perc_sb_wb[,1:3],MARGIN=1,FUN=sd)
perc_sb_nb$mean<-apply(perc_sb_nb[,1:3],MARGIN=1,FUN=mean)
perc_sb_nb$std<-apply(perc_sb_nb[,1:3],MARGIN=1,FUN=sd)
perc_wb_nb$mean<-apply(perc_wb_nb[,1:3],MARGIN=1,FUN=mean)
perc_wb_nb$std<-apply(perc_wb_nb[,1:3],MARGIN=1,FUN=sd)

colnames(perc_sb_wb)<-c(1:3,"mean","std")
colnames(perc_sb_nb)<-c(1:3,"mean","std")
colnames(perc_wb_nb)<-c(1:3,"mean","std")


ggplot(perc_sb_wb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Weak Binder Filler",
        x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
ggplot(perc_sb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Non-Binder Filler",
        x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
ggplot(perc_wb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Weak Binders with Non-Binder Filler",
        x ="Percent Weak Binders", y = "Average Percentile") + ylim(0,1)

```
Playing with other methods for determining where one distribution ranks in another reference (percentile)
```{r}
library(ggplot2)

sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-rep(501,av_lengths)

perc_sb_wb<-data.frame(vector(mode="numeric",length = 101))
perc_sb_nb<-data.frame(vector(mode="numeric",length = 101))
perc_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq_len(3)){
  print(i)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,av_lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,av_lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*av_lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,av_lengths-percent))
   }
  })
  sorted_ref_all<-sort(ref_all[ref_all <= 501])
  len_ref_all<-length(sorted_ref_all)
  perc_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  print("first done")
  perc_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  print("second done")
  perc_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
}
perc_sb_wb$mean<-apply(perc_sb_wb[,1:3],MARGIN=1,FUN=mean)
perc_sb_wb$std<-apply(perc_sb_wb[,1:3],MARGIN=1,FUN=sd)
perc_sb_nb$mean<-apply(perc_sb_nb[,1:3],MARGIN=1,FUN=mean)
perc_sb_nb$std<-apply(perc_sb_nb[,1:3],MARGIN=1,FUN=sd)
perc_wb_nb$mean<-apply(perc_wb_nb[,1:3],MARGIN=1,FUN=mean)
perc_wb_nb$std<-apply(perc_wb_nb[,1:3],MARGIN=1,FUN=sd)

colnames(perc_sb_wb)<-c(1:3,"mean","std")
colnames(perc_sb_nb)<-c(1:3,"mean","std")
colnames(perc_wb_nb)<-c(1:3,"mean","std")


ggplot(perc_sb_wb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Weak Binder Filler",
        x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
ggplot(perc_sb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Strong Binders with Non-Binder Filler",
        x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
ggplot(perc_wb_nb, aes(y=mean, x=0:100)) + 
    geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
    geom_point() + labs(title="Weak Binders with Non-Binder Filler",
        x ="Percent Weak Binders", y = "Average Percentile") + ylim(0,1)

```

testing the dmf scoring
```{r}

library(ggplot2)
library(plot.matrix)
library(gplots)

sb<-ref_all[ref_all<=50]
wb<-ref_all[ref_all > 50 & ref_all <= 500]
nb<-ref_all[ref_all>500 & ref_all<=10000]
tx_length<-441
sorted_ref_all<-sort(ref_all[ref_all<10000])
len_ref_all<-length(sorted_ref_all)
perc_sb_wb<-data.frame(vector(mode="numeric",length = 101))
perc_sb_nb<-data.frame(vector(mode="numeric",length = 101))
perc_wb_nb<-data.frame(vector(mode="numeric",length = 101))
for (i in seq(1,100)){
  print(sprintf("percent diff: %d",i))
  lengths<-ceiling((i/100)*tx_length)
  scores_mod_sb_wb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(wb,lengths-percent))
   }
  })
  scores_mod_sb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*lengths)
   if (x == 100){
    scores<-sample(sb,percent)
   } else {
     scores<-c(sample(sb,percent),sample(nb,lengths-percent))
   }
  })
  scores_mod_wb_nb<-lapply(seq(0,100),function(x){
   percent<-ceiling((x/100)*lengths)
   if (x == 100){
    scores<-sample(wb,percent)
   } else {
     scores<-c(sample(wb,percent),sample(nb,lengths-percent))
   }
  })

  perc_sb_wb[,i]<-vapply(scores_mod_sb_wb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  perc_sb_nb[,i]<-vapply(scores_mod_sb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
  perc_wb_nb[,i]<-vapply(scores_mod_wb_nb,function(x){
    mean(findInterval(x,sorted_ref_all)/len_ref_all)
  },numeric(1))
}

colnames(perc_sb_nb)<-seq(1,100)
row.names(perc_sb_nb)<-seq(0,100)
colnames(perc_sb_wb)<-seq(1,100)
row.names(perc_sb_wb)<-seq(0,100)
colnames(perc_wb_nb)<-seq(1,100)
row.names(perc_wb_nb)<-seq(0,100)


par(mar=c(5.1, 5.1, 5.1, 5.1)) # adapt margins
plot(as.matrix(perc_sb_nb)*100,xlab="Percent Different",ylab="Percent Strong Binders",main="Average Percentile: Strong Binders with No-binder Fillers")
plot(as.matrix(perc_sb_wb)*100,xlab="Percent Different",ylab="Percent Strong Binders",main="Average Percentile: Strong Binders with Weak Binder Fillers")
plot(as.matrix(perc_wb_nb)*100,xlab="Percent Different",ylab="Percent Weak Binders",main="Average Percentile: Weak Binders with No-binder Fillers")

# ggplot(perc_sb_wb, aes(y=mean, x=0:100)) + 
#     geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
#     geom_point() + labs(title="Strong Binders with Weak Binder Filler",
#         x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
# ggplot(perc_sb_nb, aes(y=mean, x=0:100)) + 
#     geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
#     geom_point() + labs(title="Strong Binders with Non-Binder Filler",
#         x ="Percent Strong Binders", y = "Average Percentile") + ylim(0,1)
# ggplot(perc_wb_nb, aes(y=mean, x=0:100)) + 
#     geom_errorbar(aes(ymin=mean-std, ymax=mean+std), width=.1) +
#     geom_point() + labs(title="Weak Binders with Non-Binder Filler",
#         x ="Percent Weak Binders", y = "Average Percentile") + ylim(0,1)


```




